# 比赛题目说明
### 股票未来收益率预测
**板块效应**指的是股票市场中同一板块的个股因共同特点或关联题材，呈现协同涨跌的联动现象。因而我们可以利用板块效应来分析股票的未来收益率。
##### 比赛目标  
现有A,B,C,D,E五只股票，他们属于相同风格概念板块，会呈现板块联动效应。你将利用股票E的自身数据信息和板块内其他股票数据信息构建模型来**预测股票E的未来5分钟收益率(Return5min)**。你的模型将根据测试集数据最终进行评估。
##### 评估指标
股票E的未来5分钟预测收益率，与真实收益率的**N日平均IC值**。排名按测试集平均IC值从大到小排名，平均IC值高则排名高。

注：IC指皮尔森相关系数，就是高中学的**样本相关系数r**。
对于样本观测数据 \(\{(x_1, y_1), (x_2, y_2), \dots, (x_n, y_n)\}\)，样本皮尔森相关系数 \(r\) 的计算公式为：

\[
r_{xy} = \frac{\sum_{i=1}^n (x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^n (x_i - \bar{x})^2} \sqrt{\sum_{i=1}^n (y_i - \bar{y})^2}}
\]等价形式：
\[
r = \frac{n\sum{x_i y_i} - \sum{x_i}\sum{y_i}}{\sqrt{[n\sum{x_i^2} - (\sum{x_i})^2][n\sum{y_i^2} - (\sum{y_i})^2]}}
\]
- \(r\) 的取值范围：\(-1 \leq r \leq 1\)
- \(r = 1\)：完全正相关
- \(r = -1\)：完全负相关
- \(r = 0\)：无线性相关(但可能有其他非线性关系)

##### 比赛数据
训练集数据包含A,B,C,D,E五只股票5日Tick级别(500ms)数据，总共33个字段，包含快照类、委托类、成交类三种数据类型。

| 字段 | 类型 | 说明 |
|------|------|------|
| **快照类数据** | | **当前时刻的供需数据(存量)** |
| Time | int64 | 时间格式：HHMMSSmmm<br>每日93000000(9:30:00.000)至112959500(11:29:59.500)、130000000(13:00:00.000)至145000000(14:50:00.000)
| BidPrice1 | int64 | 买方第1档价格(买一，买方最高出价) |
| BidPrice2 | int64 | 买方第2档价格 |
| BidPrice3 | int64 | 买方第3档价格 |
| BidPrice4 | int64 | 买方第4档价格 |
| BidPrice5 | int64 | 买方第5档价格(买方五档价格依次递减) |
| BidVolume1 | int64 | 买方第1档挂单量(与BidPrice1对应) |
| BidVolume2 | int64 | 买方第2档挂单量 |
| BidVolume3 | int64 | 买方第3档挂单量 |
| BidVolume4 | int64 | 买方第4档挂单量 |
| BidVolume5 | int64 | 买方第5档挂单量(交易数据以股为单位，但买卖必须是100股即1手的整数倍) |
| AskPrice1 | int64 | 卖方第1档价格(卖一，卖方最低出价，瞬时的卖一必定大于买一) |
| AskPrice2 | int64 | 卖方第2档价格 |
| AskPrice3 | int64 | 卖方第3档价格 |
| AskPrice4 | int64 | 卖方第4档价格 |
| AskPrice5 | int64 | 卖方第5档价格(卖方五档价格依次递增) |
| AskVolume1 | int64 | 卖方第1档挂单量 |
| AskVolume2 | int64 | 卖方第2档挂单量 |
| AskVolume3 | int64 | 卖方第3档挂单量 |
| AskVolume4 | int64 | 卖方第4档挂单量 |
| AskVolume5 | int64 | 卖方第5档挂单量 |
| **委托类数据** | | **过去区间(500ms)内新增的订单流** |
| OrderBuyNum | int64 | 区间买单笔数(一次用户的买单指令为一笔) |
| OrderSellNum | int64 | 区间卖单笔数(笔数反映投资者的交易频率或订单指令的活跃度，一笔大单和一笔小单在此贡献相同) |
| OrderBuyVolume | int64 | 区间买单量(各笔买单的股数之和) |
| OrderSellVolume | int64 | 区间卖单量(成交量反映资金的总规模) |
| **成交类数据** | | **过去区间内已匹配完成的交易流** |
| TradeBuyNum | int64 | 区间主动买单成交笔数(买方出价大于等于卖一则以卖一价**主动**成交) |
| TradeSellNum | int64 | 区间主动卖单成交笔数(卖方出价小于等于买一则以买一价**主动**成交) |
| TradeBuyVolume | int64 | 区间主动买单成交量(以股为单位) |
| TradeSellVolume | int64 | 区间主动卖单成交量 |
| TradeBuyAmount | Int64 | 区间主动买单成交额(以元为单位，是每次成交的股数乘以成交价之和) |
| TradeSellAmount | Int64 | 区间主动卖单成交额 |
| LastPrice | int64 | 最新成交价(区间内最后一笔成交价) |
| Return5min | Float64 | 未来5分钟收益率 |

注：`Return5min`的具体公式暂不清楚。但是记`MidPrice`为`BidPrice1`与`AskPrice1`的均值，以`MidPrice`五分钟后的相对增幅计算`Return5min`，得到的数据与给定数据的误差不超过1%。

---

# 作品提交格式要求
本次大赛的作品应分为**文字报告**部分和**代码附件**部分提交，文字报告部分阐述建模的过程以及展示模型的运行结果，代码部分以附件的形式提交

### ①文字报告部分的格式要求
内容应该包含：标题、作者和作者所在学校及院系、摘要、关键词、模型介绍、测试流程(特征和标签选取、特征预处理、训练集和交叉验证集的设置、模型训练和参数设定、测试结果展示和模型评价)。

**排版格式**建议为：

●论文题目用三号黑体字、一级标题用四号黑体字，并居中；二级、三级标题用小四号黑体字，左端对齐(不居中)。论文中其他汉字一律采用小四号宋体字，行距用单倍行距，打印时应尽量避免彩色打印。

●提请大家注意：摘要应该是一份简明扼要的详细摘要(包括关键词),在整篇论文评阅中占有重要权重，请认真书写(注意篇幅不能超过一页，且无需译成英文)。

●论文应该思路清晰，表达简洁(正文尽量控制在20页以内，附录页数不限)。

●引用别人的成果或其他公开的资料(包括网上查到的资料)必须按照规定的参考文献的表述方式在正文引用处和参考文献中均明确列出。正文引用处用方括号标示参考文献的编号，如[1][3]等；引用书籍还必须指出页码。参考文献按正文中的引用次序列出，其中书籍的表述方式为：[编号]作者，书名，出版地：出版社，出版年。参考文献中期刊杂志论文的表述方式为：[编号]作者，论文名，杂志名，卷期号：起止页码，出版年。参考文献中网上资源的表述方式为：[编号]作者，资源标题，网址，访问时间(年月日)。 

注：推荐使用**Typst**排版，能够方便地书写公式、代码、管理参考文献等

### ②代码附件部分的功能和格式要求
#### 文件结构要求
```
Example/
├── main.py          # [必须提交] 官方固定的预测结果生成文件，不能修改
├── MyModel.py       # [必须提交] 模型定义文件(必须包含 MyModel 类并实现相关接口)
├── utils.py         # [必须提交] 工具函数文件(给定的工具函数+自定义工具函数)
├── .pth             # [可选]模型权重文件(模型训练后所有内部参数的集合)
├── README.md        # 本说明文件
├── data/            # 示例数据目录(不提交，仅用于本地调试)
└── output/          # 预测结果输出目录
```

#### 注释与命名规范

 - 代码需符合语言标准，**变量名**采用**下划线命名法**(如 train_data )。
 - 关键步骤添加**注释说明**，例如：
    - 数据预处理：去除缺失值(作者：李四)
    - des_data = src_data.dropna()

#### 接口规范

`MyModel.py` 中的模型类 `MyModel` 必须实现以下两个方法(其余辅助方法的名称和实现完全自由)：

```python
class MyModel:
    def reset(self):
        """每个交易日开始时调用，重置模型状态"""
        pass
    
    def online_predict(self, E_row, sector_rows):
        """
        在线预测接口
        
        Args:
            E_row: dict, 当前 tick 股票 E 的数据
                   例如: {'Time': 93000000, 'BidPrice1': 100, ...}
            sector_rows: list[dict], 其他股票数据 [A_row, B_row, C_row, D_row]
        
        Returns:
            float: 预测股票 E 的 Return5min
        """
        pass
```

#### 本地测试提交

在 **`Example`** 目录下运行：
```bash
python main.py
```

测试脚本 `main.py` 会：
1. 遍历 `data/` 目录下每一天的数据
2. 调用 `model.reset()` 重置状态
3. 逐 tick 调用 `model.online_predict()` 获取预测
4. 计算并输出每日预测结果并在output目录下保存成预测结果文件

#### 依赖环境说明

为保证线上评测环境可复现并顺利运行，要求提交 `requirements.txt`，评测端会在运行前执行：

```bash
pip install -r requirements.txt
```
注：pip 是 Python 的**包管理工具**，用于安装和管理 Python 第三方库（包）。为了在一个电脑中管理多个不同的 Python 环境，需要下载第三方环境管理器工具（如**miniforge**），创建多个**虚拟环境**。不过 PyCharm 这样的集成开发环境也可以便捷地创建虚拟环境。

- 如果你使用了深度学习框架(如 PyTorch)、特征处理库等，请将对应包及版本写入 `requirements.txt`。
- 建议尽量固定版本号(例如 `torch==2.1.2`)，避免不同环境版本差异导致结果不一致。
- 如无额外依赖，也请提交 `requirements.txt`(可仅包含 numpy/pandas)。

#### 重要提示

1. **Return5min 列不可见**：测试集将不包含该字段(需要预测)
2. **禁止访问未来数据**：`online_predict()` 只能使用当前及历史数据，传入一个tick(防止未来信息泄露)
3. **评估指标**：预测值与真实值的皮尔森相关系数(IC)，按日计算后取平均
4. **避免无效IC结果**: 避免直接使用**价格类序列**(如BidPrice1、AskPrice1等)做特征或者预测值产生的高IC无效情况，比赛会对预测值做交易信号验证，以确保IC结果的预测有效性；验证方法暂不对比赛人员开放
注：这意味着模型必须建立在真正的“市场洞察”上，而非纯粹数据的“数字游戏”上。例如，根据之前发现的计算公式，直接拟合MidPrice来预测Return5min是无效的。

#### 建议
- 参考现成的赛题、工程、论文等，模仿学习
- AI是指导老师：我们对相关知识完全不了解，需要靠AI提供信息指明方向，告诉我们需要学什么、做什么，才能进行具体的实践
- 使用git远程协作，记得**按时同步！**

---

# 核心步骤参考

注意，这是一个前后依赖的流程(论文中可能就是按照这个流程进行撰写)，但我们并不是做好一步之后才做下一步，是需要往返进行优化的。
建议**由简入繁，快速迭代**：先只取小样本数据，使用最简单的特征和模型，简单地跑通从数据加载到在线预测输出的完整流程。后续再逐步深入进行构建。

### **第一阶段：本地研发与训练(批处理模式)**

#### 1. 数据预处理
对原始CSV文件进行**清洗**(处理缺失、异常，处理午休前后的数据等)、**转换**(将原始数据转换为程序的数据类型)、**对齐**(将五只股票的数据在时间上对齐，这是进行板块分析的基础)、**计算**基础指标(中间价、价差、订单流)等步骤，得到干净的、时序准确的**单股及多股对齐的面板数据**。

#### 2. 特征工程(重中之重)
基于对**金融市场微观结构**的理解，将预处理后的数据中隐藏的信号，构建出有助于模型学习和预测的特征，从而极大提升模型的预测能力。数据和特征决定了模型性能的上限，而模型和算法只是逼近这个上限的工具
注：这一步骤意味着抽象地处理数据的关系是不可行的，需要学习金融市场的相关知识，了解什么样的特征指标才能更好地代表数据。赛题要求了不能直接使用价格类序列(如BidPrice1、AskPrice1等)做特征或者预测值，因此需要主攻行为、板块等真正代表市场行为的特征，避免使用原始价格指标进行非因果关系的拟合。

####  3. 模型构建
- 使用时序方法划分训练集、验证集(如取前80%的数据训练，后20%的数据验证)
- 使用处理好的特征训练模型(需要我们学习相关知识并选择适当的模型进行训练)
- 过程中要严格保证只使用历史信息，警惕未来信息泄露
- 优先使用高效算法，平衡算力与性能

#### 4. 特征与模型迭代
- 对初步模型以**验证集IC**为指标进行评估
- 在已有特征上增加特征，计算每个特征与标签的IC，保留高相关性的。注意板块特征
- 以IC为指标微调参数优化模型
- 尝试多模型集成，加权平均，提升准确度
- 得到性能提升的最终模型


### **第二阶段：在线接口适配(关键重构)**
将本地模型改造为符合比赛接口的在线(实时流式处理)预测形式。
- 实现`MyModel`类：按照比赛要求，贴合给定的 `main.py` 的代码
- 特征工程移植：将每个特征的计算逻辑，重写为仅依赖一段固定历史数据窗口的函数
- 模拟测试：使用比赛提供的示例数据，模拟平台调用流程，确保在线预测结果与本地批处理预测结果基本一致(IC值可能因数据量少而略低，但不应崩溃)

### **第三阶段：论文撰写与工程提交**

各自撰写整个工程中自己分工的部分。清楚自己的工作过程及成果即可。

---

# 分工方案参考

- AI生成，仅供参考，具体事宜可做变动，详细分工也可调整
- 对照前文**核心步骤参考**，可以参考`test`中简单实现的全流程，了解自己的任务，以及所有人之间的衔接
- 注意独立学习与完成分工之外，定期沟通，了解所有人的大致工作，确保**流畅衔接**

### CZXSW：数据处理 特征工程师
**任务**：核心步骤参考中**第一阶段**的**1、2**步

参考`test`中实现`data_processor.py`，输出`processed_data`

### Pre-rice：模型训练 算法工程师
**任务**：核心步骤参考中**第一阶段**的**3、4**步

参考`test`中实现`simple_model.py`，训练测试调优模型，保存`simple_model.pkl`

### Br-br-br：接口实现 系统工程师
**任务**：核心步骤参考中的**第二阶段**

参考`test`中实现`MyModel.py`的相关接口，运行`main.py`进行在线测试，实现`evaluate_ic.py`评估测试结果